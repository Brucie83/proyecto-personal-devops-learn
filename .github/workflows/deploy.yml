name: ðŸš€ Sandbox DevOps - Despliegue y ConfiguraciÃ³n

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente a desplegar'
        required: true
        default: 'sandbox'
        type: choice
        options:
        - sandbox
        - staging
        - production

env:
  VM_NAME: sandbox-vm
  ADMIN_USER: sandboxadmin
  DOCKER_IMAGE: sandbox-vm:latest

jobs:
  # Job 1: ValidaciÃ³n de Infraestructura
  validate-infrastructure:
    name: ðŸ” Validar Infraestructura
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: "1.5.0"
        
    - name: ðŸ” Validar sintaxis Terraform
      run: |
        cd infrastructure
        terraform init
        terraform validate
        terraform fmt -check
        
    - name: ðŸ“‹ Validar archivos de configuraciÃ³n
      run: |
        echo "Validando archivos de configuraciÃ³n..."
        jq . secrets.example.json > /dev/null
        jq . keyvault.json > /dev/null
        echo "âœ… Archivos JSON vÃ¡lidos"

  # Job 2: Construir Imagen Docker
  build-image:
    name: ðŸ³ Construir Imagen VM
    runs-on: ubuntu-latest
    needs: validate-infrastructure
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ðŸ³ Construir imagen Docker
      run: |
        docker build -t $DOCKER_IMAGE ./docker
        docker images | grep $DOCKER_IMAGE
        
    - name: ðŸ’¾ Guardar imagen
      run: |
        docker save $DOCKER_IMAGE | gzip > sandbox-vm.tar.gz
        
    - name: ðŸ“¤ Subir artefacto
      uses: actions/upload-artifact@v4
      with:
        name: sandbox-vm-image
        path: sandbox-vm.tar.gz

  # Job 3: Desplegar Infraestructura
  deploy-infrastructure:
    name: ðŸ—ï¸ Desplegar Infraestructura
    runs-on: ubuntu-latest
    needs: build-image
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸ“¥ Descargar imagen
      uses: actions/download-artifact@v4
      with:
        name: sandbox-vm-image
        path: ./
        
    - name: ðŸ³ Cargar imagen
      run: |
        gunzip -c sandbox-vm.tar.gz | docker load
        
    - name: ðŸ”’ Verificar locks
      run: |
        if [ -f "INFRASTRUCTURE.lock" ]; then
          echo "âŒ Lock detectado. No se puede desplegar."
          exit 1
        fi
        echo "âœ… No hay locks activos"
        
    - name: ðŸš€ Desplegar VM simulada
      run: |
        # Crear directorios para discos simulados
        mkdir -p ./system ./data
        
        # Detener contenedor existente si existe
        docker stop $VM_NAME 2>/dev/null || true
        docker rm $VM_NAME 2>/dev/null || true
        
        # Ejecutar contenedor con especificaciones de VM
        docker run -d \
          --name $VM_NAME \
          --cpus=2 \
          --memory=4g \
          --restart unless-stopped \
          -p 22:22 \
          -p 80:80 \
          -p 1433:1433 \
          -v $(pwd)/system:/system \
          -v $(pwd)/data:/data \
          -e VM_NAME=$VM_NAME \
          -e ADMIN_USER=$ADMIN_USER \
          $DOCKER_IMAGE
        
        # Esperar a que el contenedor estÃ© listo
        sleep 30
        
        # Verificar que el contenedor estÃ© corriendo
        docker ps | grep $VM_NAME
        
    - name: ðŸ“‹ Verificar estado de la VM
      run: |
        echo "Estado del contenedor:"
        docker ps -a | grep $VM_NAME
        
        echo "Recursos asignados:"
        docker stats --no-stream $VM_NAME
        
        echo "Discos montados:"
        docker exec $VM_NAME ls -la /system /data

  # Job 4: Instalar Software
  install-software:
    name: ðŸ“¦ Instalar Software
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Ejecutar script de instalaciÃ³n
      run: |
        chmod +x ./scripts/install-software.sh
        ./scripts/install-software.sh
        
    - name: ðŸ”„ Reiniciar VM (simulado)
      run: |
        echo "ðŸ”„ Reiniciando VM..."
        docker restart $VM_NAME
        sleep 30
        
    - name: ðŸ“Š Verificar instalaciÃ³n
      run: |
        echo "=== Verificando software instalado ==="
        
        echo "Java:"
        docker exec $VM_NAME java -version
        
        echo "Node.js:"
        docker exec $VM_NAME node -v
        docker exec $VM_NAME npm -v
        
        echo "Git:"
        docker exec $VM_NAME git --version
        
        echo "LibreOffice:"
        docker exec $VM_NAME libreoffice --version 2>/dev/null || echo "Instalado"
        
        echo "VSCode:"
        docker exec $VM_NAME code --version 2>/dev/null || echo "Instalado"
        
        echo "Variables de entorno:"
        docker exec $VM_NAME env | grep -E "(JAVA|NODE|GIT|PATH)" | sort

  # Job 5: RotaciÃ³n de Credenciales
  rotate-credentials:
    name: ðŸ”„ Rotar Credenciales
    runs-on: ubuntu-latest
    needs: install-software
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Ejecutar rotaciÃ³n de credenciales
      run: |
        chmod +x ./scripts/rotate-credentials.sh
        ./scripts/rotate-credentials.sh
        
    - name: ðŸ“‹ Verificar nueva contraseÃ±a
      run: |
        echo "Nueva contraseÃ±a generada:"
        cat secrets.json | jq -r '.adminPassword' | head -c 20
        echo "..."
        
    - name: ðŸ” Actualizar KeyVault simulado
      run: |
        echo "Actualizando polÃ­ticas de acceso..."
        jq '.accessPolicies[0].userPrincipalName = "fabio.rincon@arroyoconsulting.net"' keyvault.json > keyvault_temp.json
        jq '.accessPolicies[1].userPrincipalName = "andres.zapata@arroyoconsulting.net"' keyvault_temp.json > keyvault.json
        rm keyvault_temp.json
        
        echo "âœ… KeyVault actualizado:"
        cat keyvault.json | jq '.accessPolicies[].userPrincipalName'

  # Job 6: ValidaciÃ³n Final
  final-validation:
    name: âœ… ValidaciÃ³n Final
    runs-on: ubuntu-latest
    needs: rotate-credentials
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸ” Verificar infraestructura
      run: |
        echo "=== ValidaciÃ³n Final ==="
        
        echo "1. Estado de la VM:"
        docker ps | grep $VM_NAME
        
        echo "2. Recursos asignados:"
        docker stats --no-stream $VM_NAME
        
        echo "3. Software instalado:"
        docker exec $VM_NAME java -version 2>&1 | head -1
        docker exec $VM_NAME node -v
        docker exec $VM_NAME git --version
        
        echo "4. Variables de entorno:"
        docker exec $VM_NAME echo "JAVA_HOME: $JAVA_HOME"
        docker exec $VM_NAME echo "PATH: $PATH"
        
        echo "5. Secretos configurados:"
        echo "Admin password: $(cat secrets.json | jq -r '.adminPassword' | head -c 10)..."
        
        echo "6. KeyVault configurado:"
        cat keyvault.json | jq '.accessPolicies | length' | echo "Usuarios con acceso: $(cat)"
        
        echo "7. Puertos abiertos:"
        docker port $VM_NAME
        
    - name: ðŸ“Š Generar reporte
      run: |
        echo "## ðŸŽ‰ Despliegue Completado Exitosamente" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Infraestructura Desplegada:" >> $GITHUB_STEP_SUMMARY
        echo "- VM Simulada: $VM_NAME" >> $GITHUB_STEP_SUMMARY
        echo "- Usuario Admin: $ADMIN_USER" >> $GITHUB_STEP_SUMMARY
        echo "- Recursos: 2 CPUs, 4GB RAM" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Software Instalado:" >> $GITHUB_STEP_SUMMARY
        echo "- Java 11" >> $GITHUB_STEP_SUMMARY
        echo "- Node.js 18" >> $GITHUB_STEP_SUMMARY
        echo "- Git" >> $GITHUB_STEP_SUMMARY
        echo "- LibreOffice (Office simulado)" >> $GITHUB_STEP_SUMMARY
        echo "- VSCode" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ” Seguridad:" >> $GITHUB_STEP_SUMMARY
        echo "- Credenciales rotadas automÃ¡ticamente" >> $GITHUB_STEP_SUMMARY
        echo "- KeyVault configurado con polÃ­ticas de acceso" >> $GITHUB_STEP_SUMMARY
        echo "- Usuarios autorizados: fabio.rincon@arroyoconsulting.net, andres.zapata@arroyoconsulting.net" >> $GITHUB_STEP_SUMMARY

  # Job 7: Limpieza (solo en PR cerrados)
  cleanup:
    name: ðŸ§¹ Limpieza
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸ”’ Verificar locks antes de limpiar
      run: |
        if [ -f "INFRASTRUCTURE.lock" ]; then
          echo "âŒ Lock detectado. No se puede limpiar."
          exit 1
        fi
        
    - name: ðŸ§¹ Limpiar recursos
      run: |
        echo "Limpiando recursos..."
        docker stop $VM_NAME 2>/dev/null || true
        docker rm $VM_NAME 2>/dev/null || true
        docker rmi $DOCKER_IMAGE 2>/dev/null || true
        echo "âœ… Limpieza completada"
