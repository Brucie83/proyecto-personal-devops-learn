name: ðŸš€ Task Manager App - CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente a desplegar'
        required: true
        default: 'development'
        type: choice
        options:
        - development
        - staging
        - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Job 1: Testing y ValidaciÃ³n
  test:
    name: ðŸ§ª Tests y ValidaciÃ³n
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸ³ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ðŸ“‹ Validar Docker Compose
      run: |
        cd app
        docker compose config
        echo "âœ… Docker Compose vÃ¡lido"
        
    - name: ðŸ” Validar archivos de configuraciÃ³n
      run: |
        echo "Validando archivos de configuraciÃ³n..."
        cd app
        if [ -f ".env.example" ]; then
          echo "âœ… .env.example encontrado"
        fi
        if [ -f "docker-compose.yml" ]; then
          echo "âœ… docker-compose.yml encontrado"
        fi

  # Job 2: Build Backend
  build-backend:
    name: ðŸ Build Backend
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸ³ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ðŸ Build Backend Image
      run: |
        cd app
        docker build -t task-manager-backend ./backend
        echo "âœ… Backend image built successfully"

  # Job 3: Build Frontend
  build-frontend:
    name: âš›ï¸ Build Frontend
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸ³ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: âš›ï¸ Build Frontend Image
      run: |
        cd app
        docker build -t task-manager-frontend ./frontend
        echo "âœ… Frontend image built successfully"

  # Job 4: Integration Test
  integration-test:
    name: ðŸ§ª Integration Tests
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸ³ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ðŸš€ Start Application Stack
      run: |
        cd app
        cp .env.example .env
        docker compose up -d
        
    - name: â³ Wait for services
      run: |
        echo "Waiting for services to be ready..."
        sleep 60
        
    - name: ðŸ” Health Check
      run: |
        cd app
        echo "Checking service health..."
        
        # Check if containers are running
        docker compose ps
        
        # Test API endpoints
        curl -f http://localhost:8080/api/health || exit 1
        echo "âœ… API health check passed"
        
    - name: ðŸ§¹ Cleanup
      run: |
        cd app
        docker compose down -v

  # Job 5: Deploy (solo en main branch)
  deploy:
    name: ðŸš€ Deploy
    runs-on: ubuntu-latest
    needs: integration-test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸ“Š Generate Deployment Report
      run: |
        echo "## ðŸŽ‰ Task Manager App - Deployment Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Build Status:" >> $GITHUB_STEP_SUMMARY
        echo "- Backend: âœ… Built successfully" >> $GITHUB_STEP_SUMMARY
        echo "- Frontend: âœ… Built successfully" >> $GITHUB_STEP_SUMMARY
        echo "- Integration Tests: âœ… Passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ—ï¸ Application Stack:" >> $GITHUB_STEP_SUMMARY
        echo "- Backend: Flask + PostgreSQL + Redis" >> $GITHUB_STEP_SUMMARY
        echo "- Frontend: React + TypeScript + TailwindCSS" >> $GITHUB_STEP_SUMMARY
        echo "- Infrastructure: Docker Compose + Nginx" >> $GITHUB_STEP_SUMMARY
        echo "- Monitoring: Prometheus + Grafana" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Quick Start:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "git clone https://github.com/${{ github.repository }}.git" >> $GITHUB_STEP_SUMMARY
        echo "cd proyecto-personal-devops-learn/app" >> $GITHUB_STEP_SUMMARY
        echo "./start.sh" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
